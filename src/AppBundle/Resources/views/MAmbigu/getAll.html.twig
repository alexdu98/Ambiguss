{% extends 'base.html.twig' %}

{% block title %}Mots Ambigus{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{{ asset('assets/vendor/DataTables/datatables.css') }}">
{% endblock %}

{% block titre %}Modération des mots ambigus{% endblock %}

{% block contenu %}
    <div class="well">
        <table id="mambigusTable" class="display responsive no-wrap table table-striped table-bordered" cellspacing="0" width="100%">
            <thead>
            <tr>
                <th>#</th>
                <th>Valeur</th>
                <th>Auteur</th>
                <th>Phrase</th>
                <th>Date de création</th>
                <th>Modificateur</th>
                <th>Date de modification</th>
                <th>Signalée</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tfoot>
            <tr>
                <th>#</th>
                <th>Valeur</th>
                <th>Auteur</th>
                <th>Phrase</th>
                <th>Date de création</th>
                <th>Modificateur</th>
                <th>Date de modification</th>
                <th>Signalée</th>
                <th>Actions</th>
            </tr>
            </tfoot>
            <tbody>
            {% for row in mambigus %}
                <tr id="mambigu-{{ row.id }}">
                    <td>{{ row.id }}</td>
                    <td class="mambigu-valeur">{{ row.valeur }}</td>
                    <td><a href="{{ path('fos_user_profile_show' , {'id':row.auteur.id}) }}">{{ row.auteur.username }}</a></td>
                    <td> a venir</td>
                    <td data-order="{{ row.dateCreation|date("U") }}">{{ row.dateCreation|date("d/m/Y à H:i") }}</td>

                    {% if row.Modificateur %}
                        <td class="mambigu-modificateur"><a href="{{ path('fos_user_profile_show' , {'id':row.modificateur.id}) }}">{{ row.modificateur.username|default('') }}</a></td>
                        <td class="mambigu-dateModification" data-order="{{ row.dateModification|date("U") }}">{{ row.dateModification|date("d/m/Y à
						H:i") }}</td>
                    {% else %}
                        <td class="mambigu-modificateur"><a href="#">{{ row.modificateur.username|default('') }}</a></td>
                        <td class="mambigu-dateModification" data-order=""></td></td>

                    {% endif %}

                    <td class="mambigu-signale">{% if row.signale %}Oui{% else %}Non{% endif %}</td>
                    <td>
                        <button class="btn btn-primary btn-sm keepMambiguButton" data-toggle="modal" data-target="#modal" data-id="{{ row.id }}" data-valeur="{{ row.valeur }}">
                            Conserver
                        </button>
                        <button class="btn btn-warning btn-sm editMambiguButton" data-toggle="modal" data-target="#modal" data-id="{{ row.id }}" data-valeur="{{ row.valeur }}"disabled>
                            Modifier
                        </button>
                        <button class="btn btn-danger btn-sm deleteMambiguButton" data-toggle="modal" data-target="#modal" data-id="{{ row.id }}" data-valeur="{{ row.valeur }}" disabled>
                            Supprimer
                        </button>

                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}


{% block js %}
    <script src="{{ asset('assets/vendor/DataTables/datatables.js') }}"></script>
    <script>
        $(document).ready(function () {
            $('#mambigusTable').DataTable({
                stateSave: true, // Enregistre les configurations
                stateSaveParams: function (settings, data) {
                    data.start = 0; // On enregistre pas la page
                    data.order = [[0, "desc"]]; // On ordonne sur l'id
                    data.search = {}; // On enregistre pas la recherche
                },
                stateDuration: 0, // pour une durée illimitée
                columnDefs: [
                    {targets: 7, orderable: false}
                ],
                order: [[0, 'asc']], // On ordonne sur l'id
                responsive: true,
                language: {url: '{{ asset('assets/vendor/DataTables/datatables.french.lang') }}'}
            });


            // Au click sur le bouton, exécute la fonction
            $('.keepMambiguButton').click(keepMambiguModal);
            function keepMambiguModal(event) {
                var button = $(this);
                setModalTitle('Conserver le mot ambigu "' + button.data('valeur') + '"');

                setModalBody('Êtes-vous certain de vouloir conserver ce mot ambigu ?<br><br>');

                setModalBody(
                    '<span class="text-danger">La mot ambigu restera tel quel et ne sera plus signalé.</span><br><br>'
                    + '<div class="text-right"><button id="mambiguKeep" class="btn btn-primary">Conserver</button></div>'
                );

                $('#mambiguKeep').click(function (data) {
                    // On affiche l'image laoding en attendant la réponse
                    $(this).after('<img src="' + urlImageLoading + '" id="loading">');
                    var url = Routing.generate('ambiguss_motambigu_keep', {'id' : button.data('id')});

                    $.getJSON(url, function (data) {
                        if (data.succes) {
                            // On trouve la ligne et on l'a supprime
                            $('#mambigusTable').DataTable().row(button.parents('tr')).remove().draw();
                            // On cache la modale
                            $('#modal').modal('hide');
                        }
                        else {
                            $(this).after('<span class="text-danger">Erreur</span>');
                        }
                    })
                        .fail(function () {
                            $(this).after('<span class="text-danger">Erreur</span>');
                        })
                        .always(function () {
                            $('#loading').remove();
                        });
                });
            }





        });
    </script>
{% endblock %}