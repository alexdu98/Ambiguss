{% extends 'base.html.twig' %}

{% block title %}Gloses{% endblock %}

{% block css %}
	<link rel="stylesheet" href="{{ asset('assets/vendor/DataTables/datatables.css') }}">
{% endblock %}

{% block titre %}Modération des gloses{% endblock %}

{% block contenu %}
	<div class="well">
		<table id="glosesTable" class="display responsive no-wrap table table-striped table-bordered" cellspacing="0" width="100%">
			<thead>
			<tr>
				<th>#</th>
				<th>Valeur</th>
				<th>Auteur</th>
				<th>Date de création</th>
				<th>Modificateur</th>
				<th>Date de modification</th>
				<th>Signalée</th>
				<th>Actions</th>
			</tr>
			</thead>
			<tfoot>
			<tr>
				<th>#</th>
				<th>Valeur</th>
				<th>Auteur</th>
				<th>Date de création</th>
				<th>Modificateur</th>
				<th>Date de modification</th>
				<th>Signalée</th>
				<th>Actions</th>
			</tr>
			</tfoot>
			<tbody>
			{% for row in gloses %}
				<tr id="glose-{{ row.id }}">
					<td>{{ row.id }}</td>
					<td class="glose-valeur">{{ row.valeur }}</td>
					<td><a href="{{ path('user_profil' , {'id':row.auteur.id}) }}">{{ row.auteur.pseudo }}</a></td>
					<td data-order="{{ row.dateCreation|date("U") }}">{{ row.dateCreation|date("d/m/Y à H:i") }}</td>

					{% if row.Modificateur %}
						<td class="glose-modificateur"><a href="{{ path('user_profil' , {'id':row.modificateur.id}) }}">{{ row.modificateur.pseudo|default('') }}</a></td>

                    {% else %}
						<td class="glose-modificateur"><a href="#">{{ row.modificateur.pseudo|default('') }}</a></td>

                    {% endif %}
					<td class="glose-dateModification" data-order="{{ row.dateModification|date("U") }}">{{ row.dateModification|date("d/m/Y à H:i") }}</td>

					<td class="glose-signale">{% if row.signale %}Oui{% else %}Non{% endif %}</td>
					<td>
						<button class="btn btn-warning btn-sm editGloseButton" data-toggle="modal" data-target="#modal" data-id="{{ row.id }}" data-valeur="{{ row.valeur }}">
							Modifier
						</button>
						<button class="btn btn-danger btn-sm deleteGloseButton" data-toggle="modal" data-target="#modal" data-id="{{ row.id }}" data-valeur="{{ row.valeur }}">
							Supprimer
						</button>

					</td>
				</tr>
			{% endfor %}
			</tbody>
		</table>
	</div>
{% endblock %}

{% block js %}
	<script src="{{ asset('assets/vendor/DataTables/datatables.js') }}"></script>
	<script>
		$(document).ready(function () {
			$('#glosesTable').DataTable({
				stateSave: true, // Enregistre les configurations
				stateSaveParams: function (settings, data) {
					data.start = 0; // On enregistre pas la page
					data.order = [[0, "desc"]]; // On ordonne sur l'id
					data.search = {}; // On enregistre pas la recherche
				},
				stateDuration: 0, // pour une durée illimitée
				columnDefs: [
					{targets: 7, orderable: false}
				],
				order: [[0, 'asc']], // On ordonne sur l'id
				responsive: true,
				language: {url: '{{ asset('assets/vendor/DataTables/datatables.french.lang') }}'}
			});

			// Au click sur le bouton, exécute la fonction
			$('.editGloseButton').click(editGloseModal);
			function editGloseModal(event) {
				var button = $(this);
				setModalSize('modal-lg');
				setModalTitle('Modifier la glose "' + button.data('valeur') + '"');
				setModalBody('{{ include('AppBundle:Glose:edit.html.twig', {'form': editGloseForm})|e('js') }}');

				$("#toggleJugements").click(function () {
					$("#jugements").toggle("slow");
				});

				// Récupère les jugements en cours
				$.post('{{ path('jugement_glose') }}', {id: button.data('id')}, function (data) {
					if (data.succes) {
						divJugement = $('#jugements');
						if (data.jugements.length === 0)
							divJugement.append('<span class="text-danger">Aucun jugement en cours</span>');
						html = '{{ include('@App/Jugement/jugement.html.twig')|e('js') }}';
						$.each(data.jugements, function (index) {
							clone = $(html);
							clone.find('.panel-heading').append(data.jugements[index].categorieJugement);
							clone.find('.panel-body').append(data.jugements[index].description);
							var profil = Routing.generate('user_profil', {id: data.jugements[index].auteur_id});
							var dt = new Date(data.jugements[index].dateCreation * 1000);
							var date = dt.getDate() + '/' + (dt.getMonth() + 1) + '/' + dt.getFullYear() + ' à ' + dt.getHours() + ':' + dt
									.getMinutes();
							clone.find('.lien-profil').attr('href', profil);
							clone.find('.lien-profil').append(data.jugements[index].auteur);
							clone.find('.date-creation').append(date);

							// Ajout de l'eventlistener valide
							clone.find('.signalement').click(function (event) {
								event.preventDefault();

								// On affiche l'image laoding en attendant la réponse
								$(this).after('<img src="' + urlImageLoading + '" id="loading">');

								$.post('{{ path('jugement_edit') }}', {
									id: data.jugements[index].id, verdict: $(this).data('verdict'), token: '{{ csrf_token
									('jugement_vote') }}'
								}, function
									(data) {
									if (data.succes) {
										clone.remove();
									}
									else {
										clone.append('<span class="text-danger">Erreur (' + data.message + ')</span>')
									}
								})
									.fail(function () {
										$(this).after('<span class="text-danger">Erreur</span>');
									})
									.always(function () {
										$('#loading').remove();
									});
							});

							divJugement.append(clone);
						});
					}
					else {

					}
				}, "json");

				$('#glose_edit_valeur').val(button.data('valeur'));
				var form = $('form[name="glose_edit"]');
				var action = form.attr('action');
				form.attr('action', action + '/' + button.data('id'));
				form.ajaxForm({
					beforeSubmit: function (arr, form, opt) {
						// On affiche l'image laoding en attendant la réponse
						$(form).after('<img src="' + urlImageLoading + '" id="loading">');
					},
					// Quand la réponse Ajax sera reçu, on appelle ce callback
					success: function (data, status, xhr, form) {
						// On supprime l'image loading
						$(form).next().remove();
						if (data.succes) {
							if (data.glose.id == button.data('id')) {
								// On trouve la ligne
								var row = button.parents('tr');
								// On met à jour la ligne
								row.find('.glose-valeur').html(data.glose.valeur);
								row.find('.glose-modificateur').html('<a href="#">' + data.glose.modificateur + '</a>');
								row.find('.glose-dateModification').html(data.glose.dateModification);
								var signale = data.glose.signale === "0" ? 'Non' : 'Oui';
								button.data('valeur', data.glose.valeur);
								row.find('.glose-signale').html(signale);
								// On trouve la ligne, on l'a met à jour
								$('#glosesTable').DataTable().row('#glose-' + button.data('id')).invalidate().draw();
								// On cache la modale
								$('#modal').modal('hide');
							}
							else {
								// On trouve la ligne et on l'a supprime
								$('#glosesTable').DataTable().row(button.parents('tr')).remove().draw();
								$(form).after('<span class="text-info">La glose existait déjà (id : ' + data.glose.id + '), les réponses et ' +
									'les liaisons avec les mots ambigus ont donc étaient fusionnées.</span>');
							}
						}
						else {
							$(form).after('<span class="text-danger">Erreur (' + data.message + ')</span>');
						}
					},
					error: function () {
						loading = $("#loading");
						next = loading.prev().nextAll();
						loading.before('<span class="text-danger">Erreur</span>');
						next.remove();
					}
				});
			}

			// Au click sur le bouton, exécute la fonction
			$('.deleteGloseButton').click(deleteGloseModal);
			function deleteGloseModal(event) {
				var button = $(this);
				setModalTitle('Supprimer la glose "' + button.data('valeur') + '"');
				var url = Routing.generate('ambiguss_glose_link', {id: button.data('id')});
				setModalBody('Êtes-vous certain de vouloir supprimer cette glose ?<br><br>');
				$.getJSON(url, function (data) {
					setModalBody(
						'<span class="text-danger">Cela supprimera <b>' + data.reponses + '</b> réponse(s).</span><br><br>'
						+ '<div class="text-right"><button id="gloseDelete" class="btn btn-danger">Supprimer</button></div>'
					);

					$('#gloseDelete').click(function () {
						// On affiche l'image laoding en attendant la réponse
						$(this).after('<img src="' + urlImageLoading + '" id="loading">');
						var url = Routing.generate('ambiguss_glose_delete', {id: button.data('id')});
						$.getJSON(url, function (data) {
							if (data.succes) {
								// On trouve la ligne et on l'a supprime
								$('#glosesTable').DataTable().row(button.parents('tr')).remove().draw();
								// On cache la modale
								$('#modal').modal('hide');
							}
							else {
								$(this).after('<span class="text-danger">Erreur</span>');
							}
						})
							.fail(function () {
								$(this).after('<span class="text-danger">Erreur</span>');
							})
							.always(function () {
								$('#loading').remove();
							});
					});
				});
			}
		});
	</script>
{% endblock %}