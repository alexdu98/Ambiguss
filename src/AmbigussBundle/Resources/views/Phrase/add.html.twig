{% extends 'base.html.twig' %}

{% block title %}Création de phrase{% endblock %}

{% block contenu %}
	<h1>Création d'une phrase</h1>

	<div class="row">
	    <div class="col-xs-12 col-sm-12 col-md-6 col-md-offset-3 well">

		    {% for flashMessage in app.session.flashbag.get('succes') %}
			    <div class="alert alert-success">{{ flashMessage }}</div>
		    {% endfor %}

		    {{ form_start(form) }}

		    {{ form_errors(form) }}

		    <div class="form-group">
		        <div id="rendu" style="background: white; color: black; padding: 5px;" hidden></div>
		    </div>

		    {{ form_row(form.contenu) }}

		    <div class="form-group">
			    <button type="button" class="btn btn-primary" id="addAmb">Le mot sélectionné est ambigu</button>
		    </div>

		    <div class="form-group">
			    <div id="ambigussbundle_phrase_reponse" data-prototype="
					{{ include('AmbigussBundle:Reponse:add.html.twig', { 'form': form.reponse.vars.prototype, 'select': form.reponse.vars.prototype.children.valeurGlose.vars.form
			    })|e
			    ('html_attr') }}">
			    </div>
		    </div>
		    {% do form.reponse.setRendered %}

		    {{ form_row(form.creer) }}

		    {{ form_rest(form) }}
		    {{ form_end(form) }}

		</div>
	</div>

{% endblock %}

{% block js %}
	<script src="{{ asset('assets/vendor/rangyinputs/rangyinputs-jquery.js') }}"></script>
	<script>
		$(document).ready(function()
		{
			var startBaliseAmbigu = '<amb>';
			var endBaliseAmbigu = '</amb>';
			var endBaliseAmbiguEscape = '<\/amb>';
			var reg = new RegExp(startBaliseAmbigu + '(.*?)' + endBaliseAmbiguEscape, 'g');
			var reg2 = new RegExp('<amb id="([0-9]+)">(.*?)' + endBaliseAmbiguEscape, 'g');
			var $container = $('div#ambigussbundle_phrase_reponse');
			var textarea = $("textarea#{{ form.contenu.vars.id }}");
			var index = 0;

			// A chaque modification du textarea par le clacier
			textarea.bind('input', function() {
				updatePhrase();
				updateRendu();
			});

			$("#addAmb").click(function () {
				if((sel = textarea.getSelection()).text != '') {
					textarea.val(
						textarea.val().slice(0, sel.start)
						+ '<amb>'
						+ sel.text
						+ '</amb>'
						+ textarea.val().slice(sel.end)
					);
					updatePhrase();
					updateRendu();
				}
			});

			function updatePhrase(){
				var phrase = textarea.val();
				var replaced = phrase.search(reg) >= 0;
				if(replaced) {
					var temp = phrase.replace(reg, function ($0, $1) {
						index++;
						addReponse($container, $1);
						return '<amb id="' + index + '">' + $1 + '</amb>';
					});
					textarea.val(temp);
				}
			}

			function updateRendu(){
				var phrase = textarea.val();
				var rendu = $("#rendu");
				var res = phrase;

				var replaced = phrase.search(reg2) >= 0;
				if(replaced) {
					html = '<b num="__num__" class="color-red amb-border" title="Ce mot est ambigu (id : __num__)' +
						'">__amb__</b>';
					res = phrase.replace(reg2, function ($0, $1, $2) {
						return html.replace(/__num__/g, $1).replace(/__amb__/g, $2);
					});
				}
				rendu.empty().append(res);

				if(rendu.html().length > 0)
					rendu.show();
				else
					rendu.hide();
			}

			function addReponse($container, motAmbigu) {
				var template = $container.attr('data-prototype')
					.replace(/__name__label__/g, '')
					.replace(/__name__/g, index)
					.replace(/__id__/g, index);
				var $prototype = $(template);
				var amb = $prototype.find('.amb');
				amb.val(motAmbigu.trim() + ' ' + amb.val());
				addDeleteLink($prototype);
				$container.append($prototype);
			}

			function addDeleteLink($prototype) {
				var $deleteLink = $('<a href="#" class="btn btn-danger">Supprimer</a>');
				$prototype.find(".deleteLink").append($deleteLink);
				$deleteLink.click(function(e) {
					var phrase = textarea.val();
					var id = $prototype.attr('id').replace(/amb/, '');
					var reg3 = new RegExp('<amb id="' + id + '">(.*?)' + endBaliseAmbiguEscape, 'g');
					textarea.val(phrase.replace(reg3, '$1'));
					updateRendu();
					$prototype.remove();
					e.preventDefault(); // évite qu'un # apparaisse dans l'URL
					return false;
				});
			}

		});
	</script>
{% endblock %}